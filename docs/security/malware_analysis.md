# Malware Analysis with virtualization-mcp

## Table of Contents
1. [Introduction](#introduction)
2. [Setup](#setup)
3. [Analysis Workflow](#analysis-workflow)
4. [Network Analysis](#network-analysis)
5. [Artifact Collection](#artifact-collection)
6. [Automation](#automation)
7. [Best Practices](#best-practices)
8. [Troubleshooting](#troubleshooting)

## Introduction

virtualization-mcp provides a powerful platform for dynamic malware analysis in isolated virtual environments. This guide covers how to set up and use virtualization-mcp for effective malware analysis while maintaining security and control.

## Setup

### Creating an Analysis Environment

```python
from mcp.client import MCPClient

client = MCPClient("http://localhost:8000")

# Create an isolated analysis VM
analysis_vm = client.create_vm(
    name="malware-analysis",
    template="windows-10",
    memory_mb=4096,
    network_mode="hostonly"  # Isolated network
)

# Take a clean snapshot
client.create_snapshot(
    vm_name="malware-analysis",
    snapshot_name="clean-state",
    description="Clean state before analysis"
)
```

### Recommended VM Settings

- **CPU**: 2-4 cores
- **RAM**: 4-8GB
- **Disk**: 50-100GB dynamically allocated
- **Networking**: Host-only or internal network
- **Shared Folders**: Disabled
- **Clipboard**: Disabled
- **Drag and Drop**: Disabled

## Analysis Workflow

### 1. Preparation

```python
# Start the VM in headless mode
client.start_vm("malware-analysis", headless=True)

# Wait for VM to boot and be ready
client.wait_for_guest_os("malwork-analysis")

# Install monitoring tools (e.g., Process Monitor, Wireshark)
# ...
```

### 2. Execution

```python
# Take pre-execution snapshot
client.create_snapshot(
    vm_name="malware-analysis",
    snapshot_name="pre-execution",
    description="State before malware execution"
)

# Execute the sample
# ...

# Monitor for changes
# ...
```

### 3. Post-Execution Analysis

```python
# Take memory dump
client.dump_vm_memory("malwork-analysis", "memory_dump.mem")

# Collect disk changes
client.export_vm_disk(
    vm_name="malware-analysis",
    disk_index=0,
    output_file="disk_image.vdi"
)
```

## Network Analysis

### Setting Up Network Monitoring

```python
# Configure port forwarding for monitoring
client.configure_port_forwarding(
    vm_name="malware-analysis",
    host_port=8000,
    guest_port=80,
    protocol="tcp"
)

# Start network capture
client.start_network_capture(
    vm_name="malwork-analysis",
    output_file="network_capture.pcap"
)
```

### Analyzing Network Traffic

1. Use Wireshark to analyze the PCAP file
2. Look for:
   - DNS queries
   - HTTP/HTTPS requests
   - Suspicious IP connections
   - Unusual ports
   - Data exfiltration attempts

## Artifact Collection

### Collecting System Artifacts

```python
# Export registry hives
client.export_registry_hive(
    vm_name="malware-analysis",
    hive="SYSTEM",
    output_file="system_hive.reg"
)

# Collect event logs
client.export_event_logs(
    vm_name="malware-analysis",
    log_types=["System", "Application", "Security"],
    output_dir="event_logs"
)
```

### Memory Analysis

1. Use Volatility or Rekall on the memory dump
2. Look for:
   - Suspicious processes
   - Injected code
   - Network connections
   - Loaded DLLs

## Automation

### Automated Analysis Script

```python
def analyze_malware(sample_path):
    # Create analysis VM
    vm_name = "analysis-{0}".format(uuid.uuid4().hex[:8])
    client.create_vm(vm_name, template="windows-10")
    
    try:
        # Setup monitoring
        client.start_network_capture(vm_name, f"{vm_name}.pcap")
        client.create_snapshot(vm_name, "clean-state")
        
        # Transfer and execute sample
        client.copy_to_vm(vm_name, sample_path, "C:\\malware.exe")
        client.execute_command(vm_name, "C:\\malware.exe", wait_time=60)
        
        # Collect artifacts
        client.dump_vm_memory(vm_name, f"{vm_name}.mem")
        client.export_vm_disk(vm_name, 0, f"{vm_name}.vdi")
        
        return {
            "memory_dump": f"{vm_name}.mem",
            "disk_image": f"{vm_name}.vdi",
            "pcap": f"{vm_name}.pcap"
        }
    finally:
        # Clean up
        client.stop_vm(vm_name, force=True)
        client.delete_vm(vm_name)
```

## Best Practices

1. **Isolation**:
   - Use host-only networking
   - Disable shared folders
   - Disable clipboard sharing

2. **Documentation**:
   - Document every step of the analysis
   - Take frequent snapshots
   - Log all commands and observations

3. **Safety**:
   - Never analyze malware on a production system
   - Use dedicated analysis VMs
   - Keep host system updated

## Troubleshooting

### Common Issues

1. **VM Won't Start**:
   - Check VirtualBox logs
   - Verify VT-x/AMD-V is enabled in BIOS
   - Ensure enough system resources are available

2. **Network Issues**:
   - Verify host-only network configuration
   - Check firewall settings
   - Ensure the VM has a valid IP address

### Getting Help

For additional support, please [open an issue](https://github.com/yourusername/virtualization-mcp/issues).



